<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare - Utah Legislative Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        ‚öñÔ∏è Compare Positions
                    </h1>
                    <p class="text-gray-600">
                        Compare any two: organizations, legislators, ideologies, or yourself
                    </p>
                </div>
                <a href="index.html" class="text-blue-600 hover:text-blue-800 font-semibold">
                    ‚Üê Back to Tracker
                </a>
            </div>
        </div>

        <!-- Selection Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            
            <!-- Left Side -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                <h2 class="text-xl font-bold mb-4 text-blue-700">Side A</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Select Type:</label>
                        <select id="entity1-type" class="w-full p-3 border rounded-lg text-lg" onchange="updateEntity1Options()">
                            <option value="">-- Choose Type --</option>
                            <option value="organization">üìä Organization</option>
                            <option value="legislator">üë§ Legislator</option>
                            <option value="ideology">üí≠ Ideology</option>
                            <option value="user">‚úã Yourself (from quiz)</option>
                        </select>
                    </div>
                    
                    <div id="entity1-selection"></div>
                    
                    <div id="entity1-preview" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="text-sm font-semibold text-blue-700 mb-1">Selected:</div>
                        <div id="entity1-preview-text" class="font-bold"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side -->
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                <h2 class="text-xl font-bold mb-4 text-green-700">Side B</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Select Type:</label>
                        <select id="entity2-type" class="w-full p-3 border rounded-lg text-lg" onchange="updateEntity2Options()">
                            <option value="">-- Choose Type --</option>
                            <option value="organization">üìä Organization</option>
                            <option value="legislator">üë§ Legislator</option>
                            <option value="ideology">üí≠ Ideology</option>
                            <option value="user">‚úã Yourself (from quiz)</option>
                        </select>
                    </div>
                    
                    <div id="entity2-selection"></div>
                    
                    <div id="entity2-preview" class="hidden bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="text-sm font-semibold text-green-700 mb-1">Selected:</div>
                        <div id="entity2-preview-text" class="font-bold"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Button -->
        <div class="text-center mb-6">
            <button 
                onclick="runComparison()" 
                id="compare-btn"
                disabled
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-12 rounded-lg text-xl shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed transition">
                ‚öñÔ∏è Compare Now
            </button>
        </div>

        <!-- Results Container -->
        <div id="results" class="hidden">
            
            <!-- Alignment Score -->
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow-lg p-8 mb-6 text-center text-white">
                <div class="text-7xl font-bold mb-2" id="alignment-score">--</div>
                <div class="text-2xl font-semibold">Alignment Score</div>
                <div class="text-lg mt-2 opacity-90" id="compared-bills">Based on -- bills</div>
                <div class="mt-4 text-sm" id="alignment-interpretation"></div>
            </div>

            <!-- Quick Stats -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl font-bold text-green-600" id="agreement-count-big">0</div>
                    <div class="text-gray-600">Agreements</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl font-bold text-red-600" id="disagreement-count-big">0</div>
                    <div class="text-gray-600">Disagreements</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600" id="compared-count">0</div>
                    <div class="text-gray-600">Bills Compared</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="border-b flex">
                    <button class="tab-btn active px-6 py-3 font-semibold flex-1 md:flex-none" data-tab="agreements" onclick="switchTab('agreements')">
                        ‚úÖ Agreements (<span id="agreement-count">0</span>)
                    </button>
                    <button class="tab-btn px-6 py-3 font-semibold flex-1 md:flex-none" data-tab="disagreements" onclick="switchTab('disagreements')">
                        ‚ùå Disagreements (<span id="disagreement-count">0</span>)
                    </button>
                    <button class="tab-btn px-6 py-3 font-semibold flex-1 md:flex-none" data-tab="stats" onclick="switchTab('stats')">
                        üìä Details
                    </button>
                </div>

                <div class="p-6">
                    <div id="tab-agreements" class="tab-content"></div>
                    <div id="tab-disagreements" class="tab-content hidden"></div>
                    <div id="tab-stats" class="tab-content hidden"></div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading data...</p>
        </div>

    </div>

    <script src="js/compare-loader.js"></script>
    <script src="js/comparison-engine.js"></script>
    <script>
        let engine;
        let selectedEntity1 = { type: null, id: null, name: null };
        let selectedEntity2 = { type: null, id: null, name: null };
        let billsData, legsData;

        // ORGANIZATIONS loaded dynamically from compare_data.json
        let ORGANIZATIONS = {};

        const IDEOLOGIES = {
            'progressive': { name: 'Progressive', desc: 'Aligned with HEAL Utah, Better Utah, etc.' },
            'conservative': { name: 'Conservative', desc: 'Aligned with Libertas Institute' },
            'libertarian': { name: 'Libertarian', desc: 'Maximum personal freedom' },
            'moderate': { name: 'Moderate', desc: 'Consensus-based positions' }
        };

        async function init() {
            try {
                // Load all data
                const billsResp = await fetch('data/bills.json');
                billsData = await billsResp.json();
                
                const compareResp = await fetch('data/compare_data.json');
                const compareData = await compareResp.json();
                
                // Use dynamic organizations from compare_data
                ORGANIZATIONS = {};
                Object.values(compareData.organizations).forEach(org => {
                    ORGANIZATIONS[org.id] = { name: org.name, emoji: org.emoji };
                });
                
                legsData = { legislators: compareData.legislators };
                
                engine = new ComparisonEngine(
                    billsData.bills,
                    compareData.legislators,
                    compareData.organizations
                );
                
                console.log('Loaded ' + Object.keys(ORGANIZATIONS).length + ' organizations');
                console.log('Loaded ' + Object.keys(compareData.legislators).length + ' legislators');
                
                // Check if user has quiz data
                const savedQuiz = localStorage.getItem('legislator_quiz_votes');
                if (savedQuiz) {
                    engine.setUserPositions(JSON.parse(savedQuiz));
                }
                
                document.getElementById('loading').style.display = 'none';
                console.log('‚úÖ Comparison engine ready');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="text-red-600">Error loading data. Please refresh.</div>';
            }
        }

        function updateEntity1Options() {
            const type = document.getElementById('entity1-type').value;
            const container = document.getElementById('entity1-selection');
            
            if (!type) {
                container.innerHTML = '';
                document.getElementById('entity1-preview').classList.add('hidden');
                selectedEntity1 = { type: null, id: null, name: null };
                updateCompareButton();
                return;
            }
            
            container.innerHTML = getEntityOptions(type, '1');
            updateCompareButton();
        }

        function updateEntity2Options() {
            const type = document.getElementById('entity2-type').value;
            const container = document.getElementById('entity2-selection');
            
            if (!type) {
                container.innerHTML = '';
                document.getElementById('entity2-preview').classList.add('hidden');
                selectedEntity2 = { type: null, id: null, name: null };
                updateCompareButton();
                return;
            }
            
            container.innerHTML = getEntityOptions(type, '2');
            updateCompareButton();
        }

        function getEntityOptions(type, side) {
            let html = '<div><label class="block text-sm font-semibold mb-2">Select:</label>';
            html += `<select id="entity${side}-id" class="w-full p-3 border rounded-lg" onchange="selectEntity(${side})">`;
            html += '<option value="">-- Choose --</option>';
            
            if (type === 'organization') {
                Object.entries(ORGANIZATIONS).forEach(([key, org]) => {
                    html += `<option value="${key}">${org.emoji} ${org.name}</option>`;
                });
            } else if (type === 'legislator') {
                const legislators = Object.keys(legsData.legislators).sort();
                legislators.forEach(leg => {
                    html += `<option value="${leg}">${leg}</option>`;
                });
            } else if (type === 'ideology') {
                Object.entries(IDEOLOGIES).forEach(([key, ideology]) => {
                    html += `<option value="${key}">${ideology.name} - ${ideology.desc}</option>`;
                });
            } else if (type === 'user') {
                const hasQuiz = localStorage.getItem('legislator_quiz_votes');
                if (hasQuiz) {
                    html += '<option value="user">Your Quiz Results</option>';
                } else {
                    html += '<option value="" disabled>Take the quiz first!</option>';
                }
            }
            
            html += '</select></div>';
            return html;
        }

        function selectEntity(side) {
            const type = document.getElementById(`entity${side}-type`).value;
            const id = document.getElementById(`entity${side}-id`).value;
            
            if (!id) return;
            
            let name = '';
            if (type === 'organization') {
                name = ORGANIZATIONS[id].name;
            } else if (type === 'legislator') {
                name = id;
            } else if (type === 'ideology') {
                name = IDEOLOGIES[id].name;
            } else if (type === 'user') {
                name = 'You';
            }
            
            if (side === '1') {
                selectedEntity1 = { type, id, name };
                document.getElementById('entity1-preview').classList.remove('hidden');
                document.getElementById('entity1-preview-text').textContent = name;
            } else {
                selectedEntity2 = { type, id, name };
                document.getElementById('entity2-preview').classList.remove('hidden');
                document.getElementById('entity2-preview-text').textContent = name;
            }
            
            updateCompareButton();
        }

        function updateCompareButton() {
            const btn = document.getElementById('compare-btn');
            const canCompare = selectedEntity1.type && selectedEntity1.id && 
                              selectedEntity2.type && selectedEntity2.id;
            btn.disabled = !canCompare;
        }

        function runComparison() {
            const result = engine.compare(
                selectedEntity1.type,
                selectedEntity1.id,
                selectedEntity2.type,
                selectedEntity2.id
            );
            
            displayResults(result);
        }

        function displayResults(result) {
            document.getElementById('results').classList.remove('hidden');
            document.scrollTo({ top: document.getElementById('results').offsetTop - 100, behavior: 'smooth' });
            
            // Alignment score
            document.getElementById('alignment-score').textContent = result.alignment + '%';
            document.getElementById('compared-bills').textContent = `Based on ${result.compared} bills`;
            
            // Interpretation
            let interpretation = '';
            if (result.alignment >= 80) interpretation = 'ü§ù Very Strong Agreement';
            else if (result.alignment >= 60) interpretation = '‚úÖ Strong Agreement';
            else if (result.alignment >= 40) interpretation = '‚öñÔ∏è Moderate Agreement';
            else if (result.alignment >= 20) interpretation = '‚ö†Ô∏è Low Agreement';
            else interpretation = '‚ùå Strong Disagreement';
            document.getElementById('alignment-interpretation').textContent = interpretation;
            
            // Stats
            document.getElementById('agreement-count').textContent = result.agreements.length;
            document.getElementById('agreement-count-big').textContent = result.agreements.length;
            document.getElementById('disagreement-count').textContent = result.disagreements.length;
            document.getElementById('disagreement-count-big').textContent = result.disagreements.length;
            document.getElementById('compared-count').textContent = result.compared;
            
            // Agreements tab
            displayAgreements(result.agreements);
            
            // Disagreements tab
            displayDisagreements(result.disagreements);
            
            // Stats tab
            displayStats(result);
        }

        function displayAgreements(agreements) {
            const container = document.getElementById('tab-agreements');
            
            if (agreements.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-8">No agreements found.</p>';
                return;
            }
            
            let html = '<div class="space-y-3">';
            agreements.forEach(agreement => {
                const posColor = agreement.position === 'Support' ? 'green' : 'red';
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <a href="${agreement.url}" target="_blank" class="font-bold text-blue-600 hover:text-blue-800">
                                    ${agreement.bill}
                                </a>
                                <p class="text-sm text-gray-700 mt-1">${agreement.title}</p>
                            </div>
                            <div class="ml-4">
                                <span class="px-3 py-1 rounded text-sm font-semibold bg-${posColor}-100 text-${posColor}-700">
                                    ${agreement.position === 'Support' ? '‚úÖ' : '‚ùå'} ${agreement.position}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayDisagreements(disagreements) {
            const container = document.getElementById('tab-disagreements');
            
            if (disagreements.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-8">No disagreements found.</p>';
                return;
            }
            
            let html = '<div class="space-y-3">';
            disagreements.forEach(d => {
                html += `
                    <div class="border-2 border-orange-200 rounded-lg p-4 bg-orange-50">
                        <div class="flex justify-between items-start mb-2">
                            <a href="${d.url}" target="_blank" class="font-bold text-blue-600 hover:text-blue-800">
                                ${d.bill}
                            </a>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">${d.title}</p>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div class="bg-blue-100 p-3 rounded">
                                <div class="text-xs font-semibold text-blue-700 mb-1">${selectedEntity1.name}</div>
                                <div class="font-bold ${d.entity1Position === 'Support' ? 'text-green-700' : 'text-red-700'}">
                                    ${d.entity1Position === 'Support' ? '‚úÖ' : '‚ùå'} ${d.entity1Position}
                                </div>
                            </div>
                            <div class="bg-green-100 p-3 rounded">
                                <div class="text-xs font-semibold text-green-700 mb-1">${selectedEntity2.name}</div>
                                <div class="font-bold ${d.entity2Position === 'Support' ? 'text-green-700' : 'text-red-700'}">
                                    ${d.entity2Position === 'Support' ? '‚úÖ' : '‚ùå'} ${d.entity2Position}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayStats(result) {
            const container = document.getElementById('tab-stats');
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold mb-4">Comparison Summary</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600">Total bills compared</div>
                                <div class="text-2xl font-bold">${result.compared}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Alignment percentage</div>
                                <div class="text-2xl font-bold text-purple-600">${result.alignment}%</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">${selectedEntity1.name} only positions</div>
                                <div class="text-2xl font-bold">${result.entity1Only}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">${selectedEntity2.name} only positions</div>
                                <div class="text-2xl font-bold">${result.entity2Only}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold mb-2">What This Means</h3>
                        <p class="text-gray-700">
                            ${selectedEntity1.name} and ${selectedEntity2.name} agreed on 
                            <strong>${result.agreements.length} out of ${result.compared}</strong> bills where both had positions.
                            This represents a <strong>${result.alignment}% alignment</strong> on shared issues.
                        </p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        init();
    </script>

    <style>
        .tab-btn.active {
            border-bottom: 3px solid #7c3aed;
            color: #7c3aed;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
    </style>
</body>
</html>
